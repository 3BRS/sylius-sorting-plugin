version: 2

jobs:
    build:
        docker:
            - image: webdevops/php-nginx:7.4-alpine
        steps:
            - checkout
            - run: composer self-update
            - restore_cache:
                  keys:
                      - composer-v1-{{ checksum "composer.lock" }}
                      - composer-v1-
            - run: COMPOSER_MEMORY_LIMIT=-1 composer install -n --prefer-dist
            - save_cache:
                  key: composer-v1-{{ checksum "composer.lock" }}
                  paths:
                      - vendor
            #            - restore_cache: # special step to restore the dependency cache if `package-lock.json` does not change
            #                  keys:
            #                      - node-v1-{{ checksum "package-lock.json" }}
            #                      # fallback to using the latest cache if no exact match is found (See https://circleci.com/docs/2.0/caching/)y
            #                      - node-v1-
            #            - run: yarn install
            #            - save_cache: # special step to save the dependency cache with the `package-lock.json` cache key template
            #                  key: node-v1-{{ checksum "package-lock.json" }}
            #                  paths:
            #                      - node_modules
            #            - run: touch storage/testing.sqlite
            #            - run: php artisan migrate --env=testing --database=sqlite_testing --force
            #            - run: ./vendor/bin/codecept build
            #            - run: ./vendor/bin/codecept run
            - run: ./bin/phpstan.sh
            - run: ./bin/ecs.sh
