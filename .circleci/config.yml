version: 2.1

workflows:
    sylius2-php8.2+:
        jobs:
            -   build:
                    name: php-<<matrix.php_version>>-sylius-<< matrix.sylius_version >>-symfony-<< matrix.symfony_version >>
                    matrix:
                        parameters:
                            sylius_version: [ "2" ]
                            php_version: [ "8.2", "8.3", "8.4" ]
                            symfony_version: [ "6.4" ,"7.1", "7.2" ]

jobs:
    build:
        parameters:
            sylius_version:
                type: string
            symfony_version:
                type: string
            php_version:
                type: string
        docker:
            -   image: webdevops/php-nginx:<< parameters.php_version >>
                environment:
                    - DATABASE_URL=mysql://root:pass_root@127.0.0.1:3306/3brs_sylius_payment_fee_plugin_%kernel.environment%?serverVersion=8.0
            -   image: cimg/mysql:8.0
                environment:
                    MYSQL_ROOT_PASSWORD: pass_root
                    MYSQL_USER: sylius
                    MYSQL_PASSWORD: pass

        steps:
            - checkout
            # to avoid installing different package "Note, selecting 'cmdtest' instead of 'yarn'"
            -   run: curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
            -   run: echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
            -   run: curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            -   run: apt-get update
                # netcat to get 'nc' command for waiting for database
            -   run: apt-get install -y nodejs yarn mariadb-client netcat-openbsd
            -   run: composer self-update

            # Sylius & Symfony in current matrix versions
            -   run: composer require "sylius/sylius:<< parameters.sylius_version >>.*" --no-interaction --no-update --no-scripts
            -   run: grep -o -E '"(symfony/[^"]+)"' composer.json | grep -v -E '(symfony/flex|symfony/webpack-encore-bundle|symfony/debug-bundle|symfony/web-profiler-bundle)' | xargs printf '%s:<< parameters.symfony_version >>.* ' | xargs composer require --no-interaction --no-update

            -   run:
                    name: Wait for database
                    command: timeout 60s bash -c -- 'while ! nc -z 127.0.0.1 3306; do sleep 0.1; done' \
                        && timeout 30s bash -c -- 'mysql --user=sylius --password=pass --host=127.0.0.1 --port=3306 -e "exit"'

            # COMPOSER PREFER LOWEST (oldest possible) #
            -   run: rm -fr vendor composer.lock
            -   run: composer update --no-interaction --prefer-lowest --no-plugins

            # DEBUG STEP 1: Check if Sylius admin bundle exists after composer install
            -   run:
                    name: Debug - Check Sylius AdminBundle location
                    command: |
                        echo "=== Checking AdminBundle path ==="
                        ls -la tests/Application/../../vendor/sylius/sylius/src/Sylius/Bundle/ || echo "Bundle directory not found"
                        ls -la tests/Application/../../vendor/sylius/sylius/src/Sylius/Bundle/AdminBundle/ || echo "AdminBundle not found"
                        echo "=== Checking AdminBundle Resources ==="
                        ls -la tests/Application/../../vendor/sylius/sylius/src/Sylius/Bundle/AdminBundle/Resources/ || echo "Resources not found"

            # DEBUG STEP 2: Clean and reinstall node modules
            -   run:
                    name: Clean node modules and yarn cache
                    command: |
                        cd tests/Application
                        rm -rf node_modules yarn.lock
                        yarn cache clean

            # DEBUG STEP 3: Install with detailed logging
            -   run:
                    name: Install yarn dependencies with debug
                    command: |
                        cd tests/Application
                        yarn install --check-files --verbose

            # DEBUG STEP 4: Check if @sylius-ui/admin was properly linked
            -   run:
                    name: Debug - Check @sylius-ui/admin linking
                    command: |
                        echo "=== Checking node_modules linking ==="
                        ls -la tests/Application/node_modules/@sylius-ui/ || echo "@sylius-ui directory not found"
                        ls -la tests/Application/node_modules/@sylius-ui/admin/ || echo "@sylius-ui/admin not linked"
                        echo "=== Checking @tabler/core ==="
                        ls -la tests/Application/node_modules/@tabler/ || echo "@tabler directory not found"
                        ls -la tests/Application/node_modules/@tabler/core/ || echo "@tabler/core not found"

            # Try to build and see what happens
            -   run:
                    name: Attempt build with error details
                    command: |
                        cd tests/Application
                        yarn build || echo "Build failed - continuing to next debug step"
            # COMPOSER PREFER DIST #
            -   run: composer update --no-interaction --prefer-dist --no-plugins
            -   run: yarn --cwd tests/Application install
            -   run: yarn --cwd tests/Application build
            -   run: (cd tests/Application && bin/console doctrine:database:create --if-not-exists --env=test -vvv)
            -   run: (cd tests/Application && bin/console doctrine:schema:update --force --env=test -vvv)
            -   run: (cd tests/Application && bin/console cache:clear --env=test -vvv)
            -   run: (cd tests/Application && bin/console cache:warmup --env=test -vvv)
            -   run: APP_ENV=test bin/phpstan.sh
            -   run: APP_ENV=test bin/ecs.sh --clear-cache
            -   run: APP_ENV=test bin/symfony-lint.sh
            -   run: APP_ENV=test bin/behat.sh
